<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quiz Esame al Ruolo Conducenti</title>
    <!-- Usiamo le CDN corrette che sappiamo funzionare -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-size: 16px;
        }
        @media (max-width: 640px) {
            html {
                font-size: 14px;
            }
        }
        button {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
  <!-- FORM DI LOGIN -->
  <form id="login-form" style="max-width: 320px; margin: 40px auto; text-align: center;">
    <h2>Accesso quiz</h2>
    <input
      type="email"
      id="email"
      placeholder="Email"
      required
      style="display:block;width:100%;margin:8px 0;padding:8px;"
    />
    <input
      type="password"
      id="password"
      placeholder="Password"
      required
      style="display:block;width:100%;margin:8px 0;padding:8px;"
    />
    <button type="submit" style="margin-top: 8px; padding: 8px 16px;">
      Entra
    </button>
  </form>

  <!-- reCAPTCHA per l'SMS -->
  <div id="recaptcha-container" style="width: 100%; text-align: center; margin-bottom: 16px;"></div>

  <!-- Sezione per inserire il codice SMS -->
  <div id="mfa-section" style="display:none; max-width: 320px; margin: 0 auto; text-align: center;">
    <p>Inserisci il codice ricevuto via SMS</p>
    <input
      type="text"
      id="mfa-code"
      placeholder="Codice SMS"
      style="display:block;width:100%;margin:8px 0;padding:8px;"
    />
    <button type="button" id="mfa-confirm" style="margin-top: 8px; padding: 8px 16px;">
      Conferma codice
    </button>
  </div>

  <!-- CONTENITORE DELLA TUA WEB APP (QUIZ) -->
  <div id="app" style="display:none;">
    <!--
      QUI SOTTO INCOLLA TUTTO IL CONTENUTO DEL TUO QUIZ
      (tutto quello che prima avevi nel <body>, esclusi eventuali <script>)
    -->

    <!-- >>> INIZIO CONTENUTO QUIZ ORIGINALE <<< -->

    <!-- INCOLLA QUI IL TUO HTML DEL QUIZ -->

    <!-- >>> FINE CONTENUTO QUIZ ORIGINALE <<< -->

  </div>

  <!-- SCRIPT FIREBASE: EMAIL+PASSWORD + SMS 2FA -->
  <script type="module">
    // Import Firebase dai CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-analytics.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      getMultiFactorResolver,
      RecaptchaVerifier,
      PhoneAuthProvider,
      PhoneMultiFactorGenerator
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    // Config del tuo progetto (identica a quella che mi hai mostrato)
    const firebaseConfig = {
      apiKey: "AIzaSyABT79FZL2feax8vGp894B7tW23qUXh9Fg",
      authDomain: "taxiquizmi.firebaseapp.com",
      projectId: "taxiquizmi",
      storageBucket: "taxiquizmi.firebasestorage.app",
      messagingSenderId: "965653747438",
      appId: "1:965653747438:web:45c45a374c7aa5497d45ff",
      measurementId: "G-105ZW1BX57"
    };

    // Inizializza Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);

    // Riferimenti agli elementi HTML
    const loginForm = document.getElementById("login-form");
    const appDiv = document.getElementById("app");
    const mfaSection = document.getElementById("mfa-section");
    const recaptchaContainerId = "recaptcha-container";

    let resolverGlobal = null;
    let verificationIdGlobal = null;
    let recaptchaVerifier = null;

    // Mostra / nasconde l'app in base all'utente loggato
    onAuthStateChanged(auth, (user) => {
      if (user) {
        if (loginForm) loginForm.style.display = "none";
        if (mfaSection) mfaSection.style.display = "none";
        if (appDiv) appDiv.style.display = "block";
      } else {
        if (loginForm) loginForm.style.display = "block";
        if (appDiv) appDiv.style.display = "none";
      }
    });

    // Inizializza reCAPTCHA per SMS 2FA
    function initRecaptcha() {
      if (!recaptchaVerifier) {
        recaptchaVerifier = new RecaptchaVerifier(
          auth,
          recaptchaContainerId,
          {
            size: "normal"
          }
        );
      }
    }

    // Avvia il secondo fattore via SMS
    async function startSmsSecondFactor(resolver) {
      initRecaptcha();

      const phoneInfoOptions = {
        multiFactorHint: resolver.hints[0],
        session: resolver.session
      };

      const phoneAuthProvider = new PhoneAuthProvider(auth);
      verificationIdGlobal = await phoneAuthProvider.verifyPhoneNumber(
        phoneInfoOptions,
        recaptchaVerifier
      );

      if (mfaSection) {
        mfaSection.style.display = "block";
      }
    }

    // Gestione submit login (email + password)
    if (loginForm) {
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // Se l'utente NON ha 2FA, qui è già dentro
        } catch (error) {
          if (error.code === "auth/multi-factor-auth-required") {
            resolverGlobal = getMultiFactorResolver(auth, error);
            await startSmsSecondFactor(resolverGlobal);
          } else {
            alert("Errore di login: " + error.message);
          }
        }
      });
    }

    // Conferma del codice SMS
    const mfaConfirmBtn = document.getElementById("mfa-confirm");
    if (mfaConfirmBtn) {
      mfaConfirmBtn.addEventListener("click", async () => {
        const code = document.getElementById("mfa-code").value;
        try {
          const cred = PhoneAuthProvider.credential(verificationIdGlobal, code);
          const assertion = PhoneMultiFactorGenerator.assertion(cred);
          await resolverGlobal.resolveSignIn(assertion);
          // Se va a buon fine, onAuthStateChanged mostrerà l'app
        } catch (err) {
          alert("Codice 2FA non valido: " + err.message);
        }
      });
    }
  </script>
</body>

</html>
